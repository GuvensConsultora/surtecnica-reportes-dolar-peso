<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <!--
    Por qué: DEBE heredar de l10n_ar.report_invoice_document porque ese template
    tiene primary="True" y es el que realmente renderiza el PDF argentino.
    Heredar de account.report_invoice_document NO afecta al PDF de AR.
    -->
    <template id="report_invoice_document_pesos" inherit_id="l10n_ar.report_invoice_document">

        <!--
        ── Estilos para mejorar legibilidad del PDF ──────────────────
        Por qué: El tamaño de fuente por defecto de Odoo es pequeño en papel.
        Aumentamos el tamaño general, de montos y del bloque de totales.
        -->
        <xpath expr="//div[@id='informations']" position="before">
            <style>
                /* Tamaño base del documento */
                .page {
                    font-size: 13px;
                }
                /* Líneas de productos */
                table.o_report_block_table tbody td,
                table.o_report_block_table thead th {
                    font-size: 13px;
                }
                /* Montos y precios más legibles */
                table.o_report_block_table td.text-end span,
                table.o_report_block_table td span[t-out] {
                    font-size: 13px;
                }
                /* Bloque de totales al pie */
                div#total table.table td,
                div#total table.table th,
                div#total table.table span {
                    font-size: 14px !important;
                }
                /* Sección informativa (cliente, fechas, etc.) */
                div#informations {
                    font-size: 13px;
                }
            </style>
        </xpath>

        <!-- ── Nota informativa en la sección de datos ──────────────── -->
        <xpath expr="//div[@id='informations']" position="inside">
            <div t-if="o.print_in_pesos and o._is_foreign_currency()" class="col-12 mt-2">
                <strong>Moneda Original:</strong> <span t-field="o.currency_id.name"/>
                <span class="mx-1">|</span>
                <strong>Impreso en:</strong> <span t-field="o.company_currency_id.name"/>
            </div>
        </xpath>

        <!--
        ── Precios de líneas ─────────────────────────────────────────
        Por qué: l10n_ar reemplaza t-field="line.price_unit" por
        t-out="l10n_ar_values['price_unit']" con display_currency: o.currency_id.
        Los VALORES ya están en pesos gracias al override de _l10n_ar_prices_and_taxes().
        Solo necesitamos cambiar display_currency para mostrar el símbolo correcto.
        -->
        <xpath expr='//span[contains(@t-out, "price_unit")]' position="attributes">
            <attribute name="t-options">{"widget": "float", "display_currency": o.company_currency_id if o.print_in_pesos and o._is_foreign_currency() else o.currency_id, "decimal_precision": "Product Price"}</attribute>
        </xpath>

        <xpath expr='//span[contains(@t-out, "price_subtotal")]' position="attributes">
            <attribute name="t-options">{"widget": "monetary", "display_currency": o.company_currency_id if o.print_in_pesos and o._is_foreign_currency() else o.currency_id}</attribute>
        </xpath>

        <!--
        ── tax_totals: NO necesita xpath ─────────────────────────────
        Por qué: El override de _l10n_ar_get_invoice_totals_for_report() en Python
        ya devuelve el dict convertido a pesos con formatLang(company_currency).
        El template llama a ese método directamente.
        -->

        <!--
        ── Pagos asociados ───────────────────────────────────────────
        Por qué: El template base muestra payment_vals['amount'] con
        display_currency: o.currency_id (USD). Necesitamos convertir
        el monto Y cambiar el símbolo de moneda cuando se imprime en pesos.
        -->
        <xpath expr='//span[contains(@t-out, "payment_vals")]' position="attributes">
            <attribute name="t-out">o.currency_id._convert(payment_vals['amount'], o.company_currency_id, o.company_id, o.invoice_date or o.date) if o.print_in_pesos and o._is_foreign_currency() else payment_vals['amount']</attribute>
            <attribute name="t-options">{"widget": "monetary", "display_currency": o.company_currency_id if o.print_in_pesos and o._is_foreign_currency() else o.currency_id}</attribute>
        </xpath>

        <!-- ── Monto residual / por pagar ───────────────────────────── -->
        <xpath expr="//span[@t-field='o.amount_residual']" position="attributes">
            <attribute name="t-if">not (o.print_in_pesos and o._is_foreign_currency())</attribute>
        </xpath>
        <xpath expr="//span[@t-field='o.amount_residual']" position="after">
            <t t-if="o.print_in_pesos and o._is_foreign_currency()">
                <t t-set="amount_residual_pesos" t-value="o.currency_id._convert(o.amount_residual, o.company_currency_id, o.company_id, o.invoice_date or o.date)"/>
                <span t-out="amount_residual_pesos" t-options="{'widget': 'monetary', 'display_currency': o.company_currency_id}"/>
            </t>
        </xpath>

        <!-- ── Nota al pie de totales ────────────────────────────────── -->
        <xpath expr="//div[@id='total']" position="after">
            <div t-if="o.print_in_pesos and o._is_foreign_currency()"
                 class="text-muted small mt-4 text-center" style="font-style: italic; border-top: 1px solid #ddd; padding-top: 10px;">
                <strong>Valores expresados en <t t-out="o.company_currency_id.name"/></strong> —
                Moneda original: <t t-out="o.currency_id.name"/> —
                Tipo de Cambio: <t t-out="o.manual_currency_rate" t-options='{"widget": "float", "precision": 4}'/> —
                Fecha: <t t-out="o.invoice_date or o.date" t-options='{"widget": "date"}'/>
            </div>
        </xpath>

    </template>
</odoo>
